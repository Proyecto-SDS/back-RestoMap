name: Despliegue entorno pruebas GCP back

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch a probar (ej: feat/bugfix-branch)'
        required: true
        default: 'develop'
      duration_minutes:
        description: 'Duraci√≥n del servicio de pruebas (en minutos)'
        required: false
        default: 15
        type: number

env:
  PROJECT_ID: restomap-478918
  GCP_REGION: us-central1
  REPO_NAME: repo
  SERVICE_NAME: test-backend-${{ github.run_id }}
  SQL_INSTANCE_ID: ci-sql-test-${{ github.run_id }}
  DB_USER: ci_user
  DB_NAME: test_db_ci

jobs:
  deploy-backend-test:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: ‚¨áÔ∏è Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: üîë Autenticaci√≥n con GCP
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/414435283954/locations/global/workloadIdentityPools/github-pool/providers/github-provider1'
        service_account: 'github-deploy-sa@restomap-478918.iam.gserviceaccount.com'
        
    - name: üèóÔ∏è Setup Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: üíæ Create Cloud SQL Test Instance
      id: create_sql
      run: |
        echo "Iniciando creaci√≥n de Cloud SQL: ${SQL_INSTANCE_ID}..."
        gcloud sql instances create ${SQL_INSTANCE_ID} \
          --database-version=POSTGRES_14 \
          --tier=db-g1-small \
          --region=${GCP_REGION} \
          --storage-type=SSD \
          --storage-auto-increase \
          --root-password=${{ secrets.CI_DB_PASSWORD }} \
          --async
        echo "SQL_INSTANCE_CONNECTION_NAME=${PROJECT_ID}:${GCP_REGION}:${SQL_INSTANCE_ID}" >> $GITHUB_ENV
        
    - name: ‚è≥ Wait for SQL Instance
      run: |
        echo "Waiting for SQL Instance..."
        MAX_RETRIES=60
        RETRY_COUNT=0
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          STATUS=$(gcloud sql instances describe ${{ env.SQL_INSTANCE_ID }} --project=${{ env.PROJECT_ID }} --format="value(state)" 2>/dev/null)
          if [ "$STATUS" = "RUNNABLE" ]; then
            echo "Instance is RUNNABLE."
            exit 0
          fi
          echo "Status: $STATUS. Retry $((RETRY_COUNT + 1))..."
          sleep 10
          RETRY_COUNT=$((RETRY_COUNT + 1))
        done
        exit 1
        
    - name: ‚öôÔ∏è Create Database and User
      run: |
        gcloud sql users create ${DB_USER} --instance=${SQL_INSTANCE_ID} --password=${{ secrets.CI_DB_PASSWORD }} --host=%
        gcloud sql databases create ${DB_NAME} --instance=${SQL_INSTANCE_ID}
        
    - name: üî® Build and Push Docker Image
      id: build-push
      run: |
        gcloud auth configure-docker ${GCP_REGION}-docker.pkg.dev
        IMAGE_URI=${GCP_REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO_NAME}/${SERVICE_NAME}:latest
        docker build -f dockerfile.backend -t $IMAGE_URI .
        docker push $IMAGE_URI
        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT

    - name: üöÄ Deploy Cloud Run Service
      id: deploy
      env:
        DB_PASS: ${{ secrets.CI_DB_PASSWORD }} 
      run: |
        gcloud run deploy ${SERVICE_NAME} \
          --image ${{ steps.build-push.outputs.image_uri }} \
          --region ${GCP_REGION} \
          --platform managed \
          --allow-unauthenticated \
          --cpu 1 \
          --memory 512Mi \
          --service-account 'github-deploy-sa@restomap-478918.iam.gserviceaccount.com' \
          --add-cloudsql-instances "${{ env.SQL_INSTANCE_CONNECTION_NAME }}" \
          --set-env-vars "DB_HOST=/cloudsql/${{ env.SQL_INSTANCE_CONNECTION_NAME }},DB_USER=${{ env.DB_USER }},DB_NAME=${{ env.DB_NAME }},DB_PASSWORD=${{ env.DB_PASS }}" \
          --quiet
          
        SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} --region ${GCP_REGION} --format 'value(status.url)')
        echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT

    # --- AQU√ç EST√Å LA MAGIA: LLAMAMOS AL ENDPOINT DEL MAIN.PY ---
    - name: üå± Poblar Base de Datos (Seed)
      run: |
        echo "‚è≥ Esperando 15s para que Flask inicie..."
        sleep 15
        
        SERVICE_URL=${{ steps.deploy.outputs.service_url }}
        echo "üöÄ Disparando Seed en: $SERVICE_URL/debug/force-seed"
        
        # curl -X POST llama al endpoint que pusimos en main.py
        # --fail hace que falle el pipeline si el servidor da error 500
        curl --fail -X POST "$SERVICE_URL/debug/force-seed"
        
        echo "‚úÖ Base de datos poblada exitosamente."

    - name: ‚úÖ Show Test URL
      run: |
        echo "### üéâ Despliegue de Pruebas Listo"
        echo "üîó **URL de Pruebas:** [API Endpoint](${{ steps.deploy.outputs.service_url }})"
        echo "---"
        echo "Este servicio se eliminar√° en **${{ github.event.inputs.duration_minutes }}** minutos."

    - name: ‚è≥ Wait and Cleanup Resources
      if: always()
      run: |
        DURATION=${{ github.event.inputs.duration_minutes }}
        if [ "$DURATION" -gt 0 ]; then
          echo "Esperando ${DURATION} minutos..."
          sleep $((${DURATION} * 60))
        fi
        echo "Limpiando..."
        gcloud run services delete ${SERVICE_NAME} --region ${GCP_REGION} --quiet || true
        gcloud sql instances delete ${SQL_INSTANCE_ID} --quiet || true